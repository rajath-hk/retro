name: Pac-Man Engine

on:
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  workflow_dispatch:

jobs:
  play-and-render:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Game Engine
        run: node engine/index.js

      - name: Commit Game State
        run: |
          git config --global user.name "Pac-Man Bot"
          git config --global user.email "bot@pacman.game"
          git add engine/state.json
          git commit -m "Update Game State [skip ci]" || echo "No changes to state"
          git push

      - name: Deploy Display Layer (Render to Graph)
        run: |
          # The script was generated by the engine
          chmod +x commit.sh
          # Run the commit generation script
          # Logic: We need to switch to a branch, but the script handles checkout --orphan
          # However, we need to push that branch.
          
          # We need to configure git user again for the script execution context if it invokes git
          export GIT_AUTHOR_NAME="Pac-Man Bot"
          export GIT_AUTHOR_EMAIL="bot@pacman.game"
          export GIT_COMMITTER_NAME="Pac-Man Bot"
          export GIT_COMMITTER_EMAIL="bot@pacman.game"
          
          ./commit.sh
          
          # Force push the display layer
          git push origin display-layer --force
